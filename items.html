<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è·¯ç«¹é«˜ä¸­è³‡è¨Šç‰©å“ç®¡ç†</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary-red: #D32F2F; --primary-blue: #1565C0; --primary-green: #2E7D32;
      --primary-color: var(--primary-blue);
      --bg-gray: #f8f9fa;
    }
    body { font-family: -apple-system, "Noto Sans TC", sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; display: flex; justify-content: center; }
    .container { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-top: 10px solid var(--primary-color); box-sizing: border-box; }
    h1 { text-align: center; color: #2C3E50; font-size: 1.4rem; margin: 0 0 15px 0; }
    .mode-info { text-align: center; font-size: 0.9rem; margin-bottom: 20px; color: #666; }
    #modeDisplay { color: var(--primary-color); font-weight: bold; font-size: 1.1rem; }
    .mode-group { display: flex; gap: 8px; margin-bottom: 20px; background: #e9ecef; padding: 4px; border-radius: 10px; }
    .mode-btn { flex: 1; padding: 12px 5px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; color: #495057; font-size: 0.9rem; transition: 0.2s; border: none; background: transparent; }
    .mode-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .mode-btn[data-mode="consume"].active { color: var(--primary-red); }
    .mode-btn[data-mode="borrow"].active { color: var(--primary-blue); }
    .mode-btn[data-mode="return"].active { color: var(--primary-green); }
    .identity-toggle { display: flex; background: #e9ecef; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
    .toggle-item { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: bold; color: #6c757d; }
    .toggle-item.active { background: white; color: var(--primary-color); }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-weight: bold; color: #34495E; font-size: 0.95rem; }
    input, select { width: 100%; padding: 14px; border: 1.5px solid #dee2e6; border-radius: 8px; box-sizing: border-box; font-size: 1rem; background-color: #fff; }
    .search-box { display: flex; gap: 8px; }
    .btn-search { width: 80px; background: #5D6D7E; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    #itemCard { margin-top: 20px; padding: 15px; border-radius: 10px; background: var(--bg-gray); border: 1px solid #dee2e6; }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: #ced4da; }
    #submitBtn { width: 100%; padding: 18px; border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; background-color: var(--primary-color); margin-top: 25px; transition: 0.2s; }
    #submitBtn:disabled { background-color: #adb5bd; cursor: not-allowed; }
    .hidden { display: none; }
    #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
    #signature-pad { width: 100%; height: 200px; border: 1px solid #ccc; background: #fff; touch-action: none; border-radius: 8px; cursor: crosshair; }
    .sig-tools { display: flex; justify-content: space-between; padding: 5px; background: #f8f9fa; }
    #scanStatus { text-align: center; font-size: 0.8rem; color: #e67e22; margin-top: 5px; font-weight: bold; }
    .add-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .full { grid-column: span 2; }
    .add-section { background: #ffffff; padding: 15px; border-radius: 10px; border: 1px solid #ced4da; margin-top: 10px; }
    .btn-save { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <h1>è·¯ç«¹é«˜ä¸­è³‡è¨Šç‰©å“ç®¡ç†</h1>
  <div class="mode-info">ç›®å‰æ¨¡å¼ï¼š<span id="modeDisplay">å€Ÿç”¨</span></div>

  <div class="mode-group">
    <button class="mode-btn" data-mode="consume" onclick="changeMode('consume', 'var(--primary-red)', 'é ˜ç”¨(æ¶ˆè€—å“)')">é ˜ç”¨</button>
    <button class="mode-btn active" data-mode="borrow" onclick="changeMode('borrow', 'var(--primary-blue)', 'å€Ÿç”¨')">å€Ÿç”¨</button>
    <button class="mode-btn" data-mode="return" onclick="changeMode('return', 'var(--primary-green)', 'æ­¸é‚„')">æ­¸é‚„</button>
  </div>

  <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

  <div class="form-group">
    <label>ç‰©å“è³‡è¨Šä¾†æº</label>
    <div class="mode-group" style="background: #f1f3f5;">
      <button class="mode-btn active" id="btn-camera" onclick="toggleSearchMethod('camera')">ç›¸æ©Ÿæƒæ</button>
      <button class="mode-btn" id="btn-manual" onclick="toggleSearchMethod('manual')">æ‰‹å‹•è¼¸å…¥</button>
      <button class="mode-btn" id="btn-add" onclick="toggleSearchMethod('add')">æ–°å¢ç‰©å“</button>
    </div>
  </div>

  <div id="method-camera" class="search-method">
    <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; background: #eee; padding: 8px; border-radius: 8px;">
        <label style="font-weight: bold; font-size: 0.9rem; cursor: pointer;">
          <input type="radio" name="scanType" value="normal" checked onclick="restartScanner()"> ä¸€èˆ¬æ¢ç¢¼
        </label>
        <label style="font-weight: bold; font-size: 0.9rem; cursor: pointer;">
          <input type="radio" name="scanType" value="long" onclick="restartScanner()"> é•·æ¢ç¢¼
        </label>
    </div>

    <div style="margin-bottom: 15px; text-align: center; border: 2px dashed #ccc; padding: 10px; border-radius: 8px;">
        <input type="file" id="photo-upload" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoUpload(this)">
        <button type="button" class="mode-btn" style="background:#f8f9fa; border:1px solid #ddd; color:#333; width:100%; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap:10px;" onclick="document.getElementById('photo-upload').click()">
          <span>ğŸ“·</span> æ‹ç…§/é¸å–ç…§ç‰‡æƒæ
        </button>
        <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">(è‹¥å³æ™‚æƒæå¤±æ•—ï¼Œè«‹è©¦ç”¨æ­¤åŠŸèƒ½)</div>
    </div>
    <div id="reader"></div>
    <div id="scanStatus">ç­‰å¾…æƒæä¸­...</div>
  </div>

  <div id="method-manual" class="search-method hidden">
    <div class="search-box">
      <input type="text" id="barcode" placeholder="è«‹æƒææˆ–è¼¸å…¥" onkeypress="if(event.keyCode==13) doSearch(this.value)">
      <button class="btn-search" onclick="doSearch(document.getElementById('barcode').value)">æœå°‹</button>
    </div>
  </div>

  <div id="method-add" class="search-method hidden">
    <div class="add-section">
      <div class="add-grid">
        <div class="form-group"><label>æ¢ç¢¼ç·¨è™Ÿ</label><input type="text" id="a_bc" placeholder="å¿…å¡«"></div>
        <div class="form-group"><label>è²¡ç”¢ç·¨è™Ÿ</label><input type="text" id="a_pid"></div>
        <div class="form-group full"><label>ç‰©å“åç¨±</label><input type="text" id="a_name" placeholder="å¿…å¡«"></div>
        <div class="form-group"><label>å» ç‰Œ</label><input type="text" id="a_brand"></div>
        <div class="form-group"><label>å‹è™Ÿ</label><input type="text" id="a_model"></div>
        <div class="form-group full"><label>é…ä»¶å…§å®¹</label><input type="text" id="a_acc" placeholder="å¦‚ï¼šé›»æºç·šã€æ»‘é¼ ..."></div>
        <div class="form-group">
          <label>å€Ÿé ˜æ¨¡å¼</label>
          <select id="a_usage"><option value="é ˜ç”¨">å¯é ˜</option><option value="å€Ÿç”¨">å¯å€Ÿ</option></select>
        </div>
        <div class="form-group">
          <label>é¡åˆ¥</label>
          <select id="a_cat"><option value="è€—æ">è€—æ</option><option value="è³‡ç”¢">è³‡ç”¢</option></select>
        </div>
        <div class="form-group"><label>ç¸½æ•¸é‡</label><input type="number" id="a_tqty" value="1"></div>
        <div class="form-group"><label>å‰©é¤˜æ•¸é‡</label><input type="number" id="a_rqty" value="1"></div>
        <div class="form-group full"><label>å­˜æ”¾ä½ç½®</label><input type="text" id="a_loc"></div>
        <div class="form-group full">
          <label>å®Œå¥½ç‹€æ…‹</label>
          <select id="a_stat"><option value="æ­£å¸¸">æ­£å¸¸</option><option value="å®Œå¥½">å®Œå¥½</option><option value="æå£">æå£</option></select>
        </div>
        <div class="form-group full"><label>å‚™è¨»</label><input type="text" id="a_note"></div>
      </div>
      <button class="btn-save" onclick="doAddNewItem()">ç¢ºèªæ–°å¢è‡³è³‡æ–™åº«</button>
    </div>
  </div>

  <div id="itemCard" class="hidden">
    <div id="cardContent">
      <div class="card-header"><h4 id="resName" style="margin:0">ç‰©å“åç¨±</h4><span class="badge" id="resCat">é¡åˆ¥</span></div>
      <div id="resAction" style="padding-top:10px; border-top:1px dashed #ced4da; margin-top:10px;"></div>
    </div>
  </div>

  <div class="form-group">
    <label>ä½¿ç”¨èº«åˆ†</label>
    <div class="identity-toggle">
      <div class="toggle-item active" data-id="faculty" onclick="changeId('faculty')">æ•™è·å“¡</div>
      <div class="toggle-item" data-id="student" onclick="changeId('student')">å­¸ç”Ÿ</div>
    </div>
    <input type="hidden" id="identityValue" value="faculty">
  </div>

  <div id="facultyInput">
    <div class="form-group"><label>å§“å</label><input type="text" id="facultyName" placeholder="è«‹è¼¸å…¥å§“å"></div>
  </div>

  <div id="studentInput" class="hidden">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
      <div class="form-group"><label>å­¸åˆ¶</label><select id="sys" onchange="updateCls()"><option value="">é¸æ“‡</option><option value="senior">é«˜ä¸­</option><option value="junior">åœ‹ä¸­</option></select></div>
      <div class="form-group"><label>ç­ç´š</label><select id="cls"><option value="">è«‹é¸å­¸åˆ¶</option></select></div>
      <div class="form-group"><label>åº§è™Ÿ</label><select id="seat"></select></div>
    </div>
  </div>

  <div id="signatureArea" class="hidden" style="margin-top:20px;">
    <label>ç°½å (è«‹ç”¨æ»‘é¼ æˆ–æ‰‹æŒ‡ç°½ç½²)</label>
    <canvas id="signature-pad"></canvas>
    <div class="sig-tools">
      <small style="color:#888">è«‹åœ¨ä¸Šæ–¹è™•ç°½å</small>
      <button type="button" onclick="clearSignature()">æ¸…é™¤</button>
    </div>
  </div>

  <button id="submitBtn" onclick="doSubmit()" disabled>è«‹å…ˆæœå°‹ç‰©å“</button>
</div>

<script>
  // ==========================================
  // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS Web App ç¶²å€ â˜…â˜…â˜…
  // ==========================================
  const API_URL = "https://script.google.com/macros/s/AKfycbx03QtyZZU34LnxCdD6pF1i-XFGfoddCs6fr9Q96NXt5Ko64euQJ1e0OrpxXfFcRJ8/exec"; 
  // ==========================================

  let curMode = 'borrow';
  let curItem = null;
  let html5QrCode = null;
  let canvas, ctx, drawing = false;
  let lastScan = "", scanMatchCount = 0;
  const NEED_MATCH = 3; 

  window.onload = () => { initSeats(); startScanner(); };

  async function callApi(action, data = {}) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, ...data })
      });
      return await response.json();
    } catch (e) {
      console.error("API Call Error", e);
      throw e;
    }
  }

  function resetUI() {
    document.getElementById('facultyName').value = "";
    document.getElementById('barcode').value = "";
    document.getElementById('itemCard').classList.add('hidden');
    document.getElementById('signatureArea').classList.add('hidden');
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = 'è«‹å…ˆæœå°‹ç‰©å“';
    if (ctx) clearSignature();
    lastScan = ""; scanMatchCount = 0;
    document.getElementById('scanStatus').innerText = "ç­‰å¾…æƒæä¸­...";
    if (!document.getElementById('method-camera').classList.contains('hidden')) {
        startScanner();
    }
  }

  function changeMode(m, color, txt) {
    curMode = m;
    document.documentElement.style.setProperty('--primary-color', color);
    document.getElementById('modeDisplay').innerText = txt;
    document.querySelectorAll('.mode-btn[data-mode]').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-mode="${m}"]`).classList.add('active');
  }

  function changeId(id) {
    document.getElementById('identityValue').value = id;
    document.querySelectorAll('.toggle-item').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-id="${id}"]`).classList.add('active');
    document.getElementById('facultyInput').classList.toggle('hidden', id !== 'faculty');
    document.getElementById('studentInput').classList.toggle('hidden', id !== 'student');
  }

  function toggleSearchMethod(method) {
    document.querySelectorAll('.search-method').forEach(el => el.classList.add('hidden'));
    document.getElementById(`method-${method}`).classList.remove('hidden');
    document.getElementById('btn-camera').classList.toggle('active', method === 'camera');
    document.getElementById('btn-manual').classList.toggle('active', method === 'manual');
    document.getElementById('btn-add').classList.toggle('active', method === 'add');
    
    if (method === 'camera') startScanner(); else stopScanner();
    
    document.getElementById('itemCard').classList.add('hidden');
    document.getElementById('signatureArea').classList.add('hidden');
    document.getElementById('submitBtn').classList.toggle('hidden', method === 'add');
  }

  function startScanner() {
    if (html5QrCode && html5QrCode.isScanning) return;
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

    const scanType = document.querySelector('input[name="scanType"]:checked').value;
    let qrBoxConfig = (scanType === 'long') ? { width: 320, height: 100 } : { width: 250, height: 150 };

    const config = { fps: 10, qrbox: qrBoxConfig, aspectRatio: 1.0 };

    html5QrCode.start(
      { facingMode: "environment" }, 
      config,
      (text) => {
        if (text === lastScan) scanMatchCount++; 
        else { lastScan = text; scanMatchCount = 1; }
        document.getElementById('scanStatus').innerText = `æ ¸å°ä¸­: ${scanMatchCount}/${NEED_MATCH}`;
        if (scanMatchCount >= NEED_MATCH) {
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          stopScanner();
          document.getElementById('scanStatus').innerText = "é©—è­‰æˆåŠŸï¼";
          document.getElementById('barcode').value = text;
          doSearch(text);
        }
      }
    ).catch(err => console.error(err));
  }

  function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => { html5QrCode = null; }).catch(err=>{});
    }
  }

  function restartScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => { html5QrCode = null; startScanner(); }).catch(err => {});
    } else {
        startScanner();
    }
  }

  function handlePhotoUpload(inputElement) {
    if (inputElement.files.length === 0) return;
    const file = inputElement.files[0];
  
    stopScanner(); // åœæ­¢è¦–è¨Šæµä»¥é‡‹æ”¾æ•ˆèƒ½çµ¦åœ–ç‰‡è§£ç¢¼
  
    document.getElementById('scanStatus').innerText = "åœ–ç‰‡è§£ç¢¼ä¸­...";
    Swal.fire({ 
        title: 'æ­£åœ¨è¾¨è­˜æ¢ç¢¼...', 
        text: 'è«‹ç¢ºä¿æ¢ç¢¼æ¸…æ™°ã€ç„¡åå…‰',
        allowOutsideClick: false, 
        didOpen: () => { Swal.showLoading(); } 
    });
  
    const photoScanner = new Html5Qrcode("reader");
    
    // ä½¿ç”¨æ›´å¼·åŠ›çš„è§£ç¢¼æ¨¡å¼ (true è¡¨ç¤ºé–‹å•Ÿæ‰€æœ‰è§£ç¢¼å¼•æ“)
    photoScanner.scanFileV2(file, true)
    .then(result => { // æ”¹åç‚º result æ¯”è¼ƒä¸å®¹æ˜“æ··æ·†
      Swal.close();
      // å¿…é ˆè®€å– result ç‰©ä»¶è£¡é¢çš„ .decodedText å±¬æ€§
      const barcodeValue = result.decodedText; 
      
      document.getElementById('barcode').value = barcodeValue;
      document.getElementById('scanStatus').innerText = "è¾¨è­˜æˆåŠŸï¼š" + barcodeValue;
      setTimeout(() => {
          doSearch(barcodeValue);
        }, 500);
    // åŸ·è¡Œæœå°‹
    doSearch(barcodeValue);
  })
    .catch(err => {
      Swal.close();
      document.getElementById('scanStatus').innerText = "è¾¨è­˜å¤±æ•—";
      Swal.fire({
          icon: 'warning',
          title: 'ç„¡æ³•è­˜åˆ¥æ¢ç¢¼',
          html: `å»ºè­°æ‹æ”æŠ€å·§ï¼š<br>
                 1. <b>æ©«å‘æ‹æ”</b>ï¼šè®“æ¢ç¢¼å¡«æ»¿ç•«é¢é•·é‚Š<br>
                 2. <b>é¿å…åå…‰</b>ï¼šå´ä¸€é»æ‹ï¼Œåˆ¥è®“ç‡ˆå…‰ç›´å°„æ¨™ç±¤<br>
                 3. <b>æ‰‹å‹•å°ç„¦</b>ï¼šæ‹ç…§å‰å…ˆé»ä¸€ä¸‹è¢å¹•æ¢ç¢¼è™•`,
          confirmButtonText: 'å†è©¦ä¸€æ¬¡'
      });
    })
    .finally(() => {
       inputElement.value = ''; 
       photoScanner.clear();
    });
}

  function doSearch(val) {
    if (!val) return;
    val = val.toString().trim(); // å»ºè­°åŠ å…¥ï¼šç¢ºä¿æ¢ç¢¼å‰å¾Œæ²’æœ‰ç©ºç™½æˆ–æ›è¡Œç¬¦è™Ÿ
    Swal.fire({ title: 'æŸ¥è©¢ä¸­...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
    callApi('search', { barcode: val }).then(item => {
      Swal.close();
      if (item && item.found) {
        curItem = item;
        document.getElementById('itemCard').classList.remove('hidden');
        document.getElementById('resName').innerText = item.name;
        document.getElementById('resCat').innerText = item.category;
        let acc = item.accessories ? `<div style="color:#e67e22; font-size:0.9rem;">é…ä»¶ï¼š${item.accessories}</div>` : "";
        let html = acc + (item.category === "è€—æ" ? 
          `åº«å­˜: <b>${item.stock}</b><br><label style="margin-top:10px">æ•¸é‡</label><input type="number" id="qty" value="1" min="1">` :
          `ç›®å‰ç‹€æ…‹: <b>${item.status}</b><br><label style="margin-top:10px">è®Šæ›´ç‚º</label><select id="status"><option value="æ­£å¸¸">æ­£å¸¸</option><option value="å®Œå¥½">å®Œå¥½</option><option value="æå£">æå£</option></select>`);
        document.getElementById('resAction').innerHTML = html;
        document.getElementById('signatureArea').classList.remove('hidden');
        setTimeout(initSignaturePad, 100); 
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerText = 'ç¢ºèªé€å‡ºäº¤æ˜“';
      } else {
        stopScanner();
        Swal.fire({
          icon: 'question', title: 'æ‰¾ä¸åˆ°è³‡æ–™', text: `æ¢ç¢¼ã€Œ${val}ã€ä¸å­˜åœ¨ã€‚`, showCancelButton: true, confirmButtonText: 'å‰å¾€æ–°å¢'
        }).then(res => { if (res.isConfirmed) { toggleSearchMethod('add'); document.getElementById('a_bc').value = val; } });
      }
    }).catch(err => Swal.fire({
        icon: 'error',
        title: 'iPad é€£ç·šå¤±æ•—',
        text: 'åŸå› : ' + (err.message || err.toString()) + 'ã€‚è«‹ç¢ºèªç¶²è·¯æˆ–é‡æ–°æ•´ç†ã€‚'
      }));
  }

  function initSignaturePad() {
    canvas = document.getElementById('signature-pad');
    ctx = canvas.getContext('2d');
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
    ctx.strokeStyle = "#000"; ctx.lineWidth = 3; ctx.lineCap = "round";
    const getPos = (e) => {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if (e.touches) e.preventDefault(); };
    const move = (e) => { if (!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if (e.touches) e.preventDefault(); };
    const stop = () => { drawing = false; };
    canvas.addEventListener('touchstart', start, {passive: false});
    canvas.addEventListener('touchmove', move, {passive: false});
    canvas.addEventListener('touchend', stop);
    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', stop);
  }

  function clearSignature() { if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height); }

  function doSubmit() {
    const idMode = document.getElementById('identityValue').value;
    let user = (idMode === 'faculty') ? document.getElementById('facultyName').value.trim() : `${document.getElementById('cls').value}-${document.getElementById('seat').value}`;
    if (!user || user.includes('undefined') || user === "-") return Swal.fire('ä¸å®Œæ•´', 'è«‹è¼¸å…¥å§“åæˆ–ç­åº§', 'warning');
    const sigData = canvas.toDataURL("image/png");
    if (sigData.length < 2000) return Swal.fire('ç¼ºå°‘ç°½å', 'è«‹å…ˆç°½å', 'warning');
    Swal.fire({ title: 'å„²å­˜ä¸­...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
    const p = {
      mode: document.getElementById('modeDisplay').innerText,
      barcode: curItem.barcode, propId: curItem.propId, category: curItem.category, itemRow: curItem.row,
      identity: idMode === 'faculty' ? 'æ•™è·å“¡' : 'å­¸ç”Ÿ', userName: user, signatureData: sigData,
      qty: document.getElementById('qty') ? parseInt(document.getElementById('qty').value) : 1,
      itemStatus: document.getElementById('status') ? document.getElementById('status').value : 'æ­£å¸¸'
    };
    callApi('submit', p).then(r => {
      if (r.success) Swal.fire({ icon: 'success', title: 'å®Œæˆ', timer: 1000, showConfirmButton: false }).then(() => resetUI());
      else Swal.fire('å¤±æ•—', r.error, 'error');
    }).catch(err => Swal.fire('éŒ¯èª¤', 'é€£ç·šå¤±æ•—', 'error'));
  }

  function doAddNewItem() {
    const p = {
      barcode: document.getElementById('a_bc').value.trim(),
      propId: document.getElementById('a_pid').value.trim(),
      name: document.getElementById('a_name').value.trim(),
      brand: document.getElementById('a_brand').value.trim(),
      model: document.getElementById('a_model').value.trim(),
      accessories: document.getElementById('a_acc').value.trim(),
      usageType: document.getElementById('a_usage').value,
      category: document.getElementById('a_cat').value,
      totalQty: document.getElementById('a_tqty').value,
      remainQty: document.getElementById('a_rqty').value,
      location: document.getElementById('a_loc').value,
      status: document.getElementById('a_stat').value,
      notes: document.getElementById('a_note').value
    };
    if (!p.barcode || !p.name) return Swal.fire('ç¼ºå°‘è³‡æ–™', 'æ¢ç¢¼èˆ‡åç¨±ç‚ºå¿…å¡«', 'warning');
    Swal.fire({ title: 'å„²å­˜ä¸­...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
    callApi('add', p).then(r => {
      if (r.success) { Swal.fire('æˆåŠŸ', 'æ–°å¢å®Œæˆ', 'success'); resetUI(); }
      else Swal.fire('å¤±æ•—', r.error, 'error');
    });
  }

  function updateCls() {
    const s = document.getElementById('sys').value, c = document.getElementById('cls');
    c.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
    if (s === 'senior') { for(let g=4; g<=6; g++) for(let i=1; i<=7; i++) { let v=`${g}${i<10?'0'+i:i}`; c.add(new Option(v, v)); } }
    else if (s === 'junior') { const cnt=[11,12,11]; for(let g=1; g<=3; g++) for(let i=1; i<=cnt[g-1]; i++) { let v=`${g}${i<10?'0'+i:i}`; c.add(new Option(v, v)); } }
  }

  function initSeats() {
    const s = document.getElementById('seat'); s.innerHTML = '<option value="">åº§è™Ÿ</option>';
    for(let i=1; i<=45; i++) { let v=i<10?'0'+i:i; s.add(new Option(v, v)); }
  }
</script>

</body>
</html>
