<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>è·¯ç«¹é«˜ä¸­å±…å®¶è¼‰å…·å€Ÿç”¨ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    body { background-color: #f4f7f6; padding-bottom: 100px; font-family: -apple-system, "Noto Sans TC", sans-serif; }
    .container { max-width: 900px; }

    /* --- é ‚éƒ¨æ’ç‰ˆå€å¡Š --- */
    .header-section {
      display: flex;
      flex-direction: column;
      align-items: center;      
      padding-top: 20px;        
      margin-bottom: 40px;      
    }

    h2 { font-weight: 800; color: #2c3e50; margin: 0 0 5px 0; }
    .sub-title { color: #7f8c8d; margin-bottom: 20px; text-align: center; }

    /* --- é‡æ–°æ•´ç†æŒ‰éˆ• --- */
    .btn-refresh {
      padding: 10px 24px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);
    }
    .btn-refresh:active { transform: scale(0.95); }
    .btn-refresh:disabled { background-color: #cccccc; cursor: not-allowed; }

    .spin { animation: rotate 1s linear infinite; }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .status-msg {
      height: 20px;
      font-size: 14px;
      color: #28a745;
      margin-top: 8px;
      font-weight: bold;
      visibility: hidden; 
    }
    .status-msg.show { visibility: visible; }

    /* --- è¨­å‚™å¡ç‰‡æ¨£å¼ --- */
    .device-card {
      height: 110px; border-radius: 15px; cursor: pointer; border: 3px solid transparent;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s;
    }
    .status-available { background-color: #ebfaef !important; color: #27ae60; }
    .status-inuse { background-color: #fdf2f2 !important; color: #e74c3c; }
    .status-other { background-color: #f2f2f2 !important; color: #7f8c8d; }
    .selected { border-color: #3498db !important; transform: translateY(-3px); box-shadow: 0 8px 15px rgba(52, 152, 219, 0.2); }
    .device-id { font-size: 1.6rem; font-weight: 900; }
    .device-info { font-size: 1.1rem; font-weight: 700; max-width: 90%; text-align: center; }

    /* èº«åˆ†åˆ‡æ› */
    .role-switch { background: #eee; border-radius: 10px; padding: 5px; display: flex; margin-bottom: 20px; }
    .role-btn { flex: 1; border: none; padding: 10px; border-radius: 8px; font-weight: bold; transition: 0.3s; }
    .role-btn.active { background: #fff; color: #0d6efd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    #signature-pad-container { border: 2px solid #ddd; background: #fff; height: 180px; border-radius: 10px; }
    canvas { width: 100%; height: 100%; touch-action: none; }
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; border-top: 1px solid #ddd; display: none; z-index: 1000; }
  </style>
</head>
<body>

<div class="container">
  <div class="header-section">
    <h2>è·¯ç«¹é«˜ä¸­å±…å®¶è¼‰å…·å€Ÿç”¨ç³»çµ±</h2>
    <p class="sub-title">ğŸ’¡ æç¤ºï¼šé»é¸è¼‰å…·å¯é€²è¡Œæ‰¹é‡å€Ÿé‚„</p>
    
    <button id="refresh-btn" class="btn-refresh" onclick="handleRefreshClick()">
      <span id="btn-icon">ğŸ”„</span>
      <span id="btn-text">é‡æ–°æ•´ç†</span>
    </button>
    <div id="status-message" class="status-msg">å…§å®¹å·²æ›´æ–°ï¼</div>
  </div>
  
  <div id="loading" class="text-center mt-2">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2 text-muted">é€£ç·šä¸­...</p>
  </div>
  
  <div id="grid-container" class="row g-3"></div>
</div>

<div class="bottom-bar" id="bottomBar">
  <div class="d-flex justify-content-between align-items-center">
    <span class="fs-5">å·²é¸ <b id="selectedCount" class="text-primary">0</b> å°</span>
    <button class="btn btn-primary btn-lg px-5" onclick="openBatchModal()">é–‹å§‹åŸ·è¡Œ</button>
  </div>
</div>

<div class="modal fade" id="actionModal" data-bs-backdrop="static" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold"><span id="modalActionTitle">æ‰¹é‡è™•ç†</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="role-switch" id="roleToggleArea">
          <button class="role-btn active" id="btnFaculty" onclick="setRole('Faculty')">æ•™è·å“¡</button>
          <button class="role-btn" id="btnStudent" onclick="setRole('Student')">å­¸ç”Ÿ</button>
        </div>
        
        <div id="facultyInputArea" class="mb-3">
          <label class="form-label fw-bold" id="nameLabel">æ•™è·å“¡å§“å</label>
          <input type="text" id="facultyName" class="form-control" placeholder="è«‹è¼¸å…¥å§“å">
        </div>

        <div id="studentInputArea" class="mb-3" style="display:none;">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label fw-bold">å­¸åˆ¶</label>
              <select id="selSystem" class="form-select" onchange="updateClassList()"></select>
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">ç­ç´š</label>
              <select id="selClass" class="form-select"></select>
            </div>
          </div>
          <div class="mt-2">
            <label class="form-label fw-bold">åº§è™Ÿ</label>
            <select id="selSeat" class="form-select"></select>
          </div>
        </div>
        
        <div class="mb-3" id="reasonArea">
          <label class="form-label fw-bold">å€Ÿç”¨åŸå› </label>
          <select id="borrowReason" class="form-select">
            <option value="æ•™å­¸ç”¨">æ•™å­¸ç”¨</option>
            <option value="å ±è®€ç”¨">å ±è®€ç”¨</option>
            <option value="åŒå­¸è«‹å‡(æ··æˆæ•™å­¸)">åŒå­¸è«‹å‡(æ··æˆæ•™å­¸)</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label fw-bold">é…ä»¶ç¢ºèª</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="powerCable" checked>
              <label class="form-check-label" for="powerCable">é›»æºç·š</label>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label fw-bold">å‚™è¨»</label>
            <input type="text" id="note" class="form-control" placeholder="å¦‚æœ‰å»¶é•·ç·šè«‹è¨»è¨˜">
          </div>
        </div>
        
        <div class="mb-2">
          <label class="form-label fw-bold">é›»å­ç°½å</label>
          <div id="signature-pad-container"><canvas id="signature-canvas"></canvas></div>
          <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="signaturePad.clear()">æ¸…é™¤é‡ç°½</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary w-100 fw-bold py-2" id="submitBtn" onclick="submitBatch()">ç¢ºèªæäº¤</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS Web App ç¶²å€ â˜…â˜…â˜…
  // ==========================================
  const API_URL = "https://script.google.com/macros/s/AKfycbxAWulpRiVMiwYUSj5IFpc-9jctUAqoaylK6p7B9JZU7CgubeZiIugjIAfttoAAn7yq/exec";
  // ==========================================

  let signaturePad;
  let actionModal;
  let selectedDevices = [];
  let userMap = {};
  let currentRole = 'Faculty';

  window.onload = () => {
    actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
    signaturePad = new SignaturePad(document.getElementById('signature-canvas'));
    document.getElementById('actionModal').addEventListener('shown.bs.modal', resizeCanvas);
    loadDevices();
    loadUserData();
    generateSeatNumbers();
  };

  // é€šç”¨ API å‘¼å«å‡½å¼
  async function callApi(action, data = {}) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, ...data })
      });
      return await response.json();
    } catch (e) {
      console.error("API Error:", e);
      Swal.fire('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦', 'error');
      throw e;
    }
  }

  function handleRefreshClick() {
    const btn = document.getElementById('refresh-btn');
    const btnIcon = document.getElementById('btn-icon');
    const btnText = document.getElementById('btn-text');
    const statusMsg = document.getElementById('status-message');
    btn.disabled = true;
    btnText.innerText = "æ­£åœ¨é‡æ–°æ•´ç†...";
    btnIcon.classList.add('spin');
    statusMsg.classList.remove('show');
    loadDevices();
  }

  function setRole(role) {
    currentRole = role;
    document.getElementById('btnFaculty').classList.toggle('active', role === 'Faculty');
    document.getElementById('btnStudent').classList.toggle('active', role === 'Student');
    document.getElementById('facultyInputArea').style.display = (role === 'Faculty') ? 'block' : 'none';
    document.getElementById('studentInputArea').style.display = (role === 'Student') ? 'block' : 'none';
  }

  function loadUserData() {
    callApi('getUserData').then(data => {
      userMap = data;
      const selSystem = document.getElementById('selSystem');
      selSystem.innerHTML = '';
      Object.keys(userMap).forEach(sys => {
        selSystem.innerHTML += `<option value="${sys}">${sys}</option>`;
      });
      updateClassList();
    });
  }

  function updateClassList() {
    const sys = document.getElementById('selSystem').value;
    const selClass = document.getElementById('selClass');
    selClass.innerHTML = '';
    if (userMap[sys]) {
      userMap[sys].forEach(cls => {
        selClass.innerHTML += `<option value="${cls}">${cls}</option>`;
      });
    }
  }

  function generateSeatNumbers() {
    const selSeat = document.getElementById('selSeat');
    for (let i = 1; i <= 40; i++) {
      let val = i.toString().padStart(2, '0');
      selSeat.innerHTML += `<option value="${val}è™Ÿ">${val}è™Ÿ</option>`;
    }
    selSeat.innerHTML += `<option value="å…¶ä»–">å…¶ä»–</option>`;
  }

  function resizeCanvas() {
    const canvas = document.getElementById('signature-canvas');
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }

  function loadDevices() {
    selectedDevices = [];
    document.getElementById('bottomBar').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('grid-container').innerHTML = '';
    
    callApi('getDeviceStatus').then(devices => {
        renderGrid(devices);
        resetRefreshButton();
    });
  }

  function resetRefreshButton() {
    const btn = document.getElementById('refresh-btn');
    const btnIcon = document.getElementById('btn-icon');
    const btnText = document.getElementById('btn-text');
    const statusMsg = document.getElementById('status-message');
    btn.disabled = false;
    btnText.innerText = "é‡æ–°æ•´ç†";
    btnIcon.classList.remove('spin');
    statusMsg.classList.add('show');
    setTimeout(() => { statusMsg.classList.remove('show'); }, 2500);
  }

  function renderGrid(devices) {
    document.getElementById('loading').style.display = 'none';
    const container = document.getElementById('grid-container');
    devices.forEach(d => {
      let statusClass = (d.status === 'å¯å€Ÿç”¨') ? 'status-available' : (d.status === 'å…¶ä»–' ? 'status-other' : 'status-inuse');
      let displayInfo = (d.status === 'å¯å€Ÿç”¨') ? 'å¯å€Ÿç”¨' : (d.status === 'å…¶ä»–' ? (d.user || 'ç¶­ä¿®/å…¶ä»–') : d.user);
      container.innerHTML += `
        <div class="col-6 col-md-3">
          <div class="device-card ${statusClass}" id="card-${d.id}" onclick="toggleSelect('${d.id}', '${d.status}', '${d.user}')">
            <div class="device-id">${d.id}</div>
            <div class="device-info text-truncate">${displayInfo}</div>
          </div>
        </div>`;
    });
  }

  function toggleSelect(id, status, user) {
    if (status === 'å…¶ä»–') {
      Swal.fire('ç„¡æ³•é¸å–', 'æ­¤è¼‰å…·ç›®å‰ç‹€æ…‹ç‚ºã€Œå…¶ä»–ã€ï¼Œä¸å¯é€²è¡Œå€Ÿé‚„', 'error');
      return;
    }
    const card = document.getElementById('card-' + id);
    const index = selectedDevices.findIndex(d => d.id === id);
    if (index > -1) {
      selectedDevices.splice(index, 1);
      card.classList.remove('selected');
    } else {
      if (selectedDevices.length > 0 && selectedDevices[0].status !== status) {
        Swal.fire('é¸å–é™åˆ¶', 'ä¸å¯åŒæ™‚é¸å–å€Ÿå‡ºèˆ‡æ­¸é‚„è¼‰å…·', 'warning');
        return;
      }
      selectedDevices.push({id, status, user});
      card.classList.add('selected');
    }
    document.getElementById('bottomBar').style.display = selectedDevices.length > 0 ? 'block' : 'none';
    document.getElementById('selectedCount').innerText = selectedDevices.length;
  }

  function openBatchModal() {
    const type = (selectedDevices[0].status === 'å¯å€Ÿç”¨') ? 'å€Ÿå‡º' : 'æ­¸é‚„';
    document.getElementById('modalActionTitle').innerText = `æ‰¹é‡${type} (${selectedDevices.map(d=>d.id).join(",")})`;
    
    const reasonArea = document.getElementById('reasonArea');
    const nameLabel = document.getElementById('nameLabel');

    if (type === 'æ­¸é‚„') {
      nameLabel.innerText = "æ­¸é‚„è€…";
      document.getElementById('roleToggleArea').style.display = 'none';
      document.getElementById('facultyInputArea').style.display = 'block';
      document.getElementById('studentInputArea').style.display = 'none';
      
      document.getElementById('facultyName').value = selectedDevices[0].user;
      
      reasonArea.style.display = 'none'; 
      document.getElementById('borrowReason').value = 'å…¶ä»–'; 
    } else {
      nameLabel.innerText = "æ•™è·å“¡å§“å";
      document.getElementById('roleToggleArea').style.display = 'flex';
      setRole('Faculty');
      document.getElementById('facultyName').value = '';
      reasonArea.style.display = 'block';
      document.getElementById('borrowReason').value = 'æ•™å­¸ç”¨'; 
    }
    actionModal.show();
  }

  function submitBatch() {
    let finalName = "";
    if (currentRole === 'Faculty' || selectedDevices[0].status === 'å¤–å€Ÿä¸­') {
      finalName = document.getElementById('facultyName').value;
    } else {
      finalName = `${document.getElementById('selSystem').value} ${document.getElementById('selClass').value} ${document.getElementById('selSeat').value}`;
    }

    if (!finalName || signaturePad.isEmpty()) {
      Swal.fire('å¡«å¯«æœªå®Œæˆ', 'è«‹æä¾›å§“åèˆ‡ç°½å', 'info');
      return;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

    const payload = {
      deviceIds: selectedDevices.map(d => d.id),
      userName: finalName,
      type: (selectedDevices[0].status === 'å¯å€Ÿç”¨') ? 'å€Ÿå‡º' : 'æ­¸é‚„',
      reason: document.getElementById('borrowReason').value,
      powerCable: document.getElementById('powerCable').checked,
      note: document.getElementById('note').value,
      signature: signaturePad.toDataURL()
    };

    callApi('processTransaction', payload).then(res => {
        if(res.status === 'success'){
            Swal.fire('å®Œæˆ', res.message, 'success');
            actionModal.hide();
            loadDevices();
        } else {
            Swal.fire('å¤±æ•—', res.message, 'error');
        }
        btn.disabled = false; btn.innerText = "ç¢ºèªæäº¤";
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
