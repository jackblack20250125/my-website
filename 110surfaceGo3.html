<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>è·¯ç«¹é«˜ä¸­å±…å®¶è¼‰å…·å€Ÿç”¨ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    body { background-color: #f8f9fa; padding-bottom: 100px; font-family: -apple-system, "Noto Sans TC", sans-serif; }
    .container { max-width: 900px; }

    /* --- é ‚éƒ¨æ’ç‰ˆ --- */
    .header-section {
      display: flex; flex-direction: column; align-items: center;      
      padding-top: 25px; margin-bottom: 30px;      
    }
    h2 { font-weight: 800; color: #2c3e50; margin: 0 0 5px 0; letter-spacing: -0.5px; }
    .sub-title { color: #6c757d; margin-bottom: 15px; font-size: 0.95rem; }

    /* --- é‡æ–°æ•´ç†æŒ‰éˆ• --- */
    .btn-refresh {
      padding: 8px 20px; font-size: 15px; font-weight: 600;
      cursor: pointer; background-color: #fff; color: #0d6efd;
      border: 1px solid #dee2e6; border-radius: 50px;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .btn-refresh:hover { background-color: #f1f3f5; transform: translateY(-1px); }
    .btn-refresh:active { transform: scale(0.98); }
    .spin { animation: rotate 0.8s linear infinite; }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* --- è¨­å‚™å¡ç‰‡ --- */
    .device-card {
      height: 120px; border-radius: 16px; cursor: pointer; border: 2px solid transparent;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
      transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative; overflow: hidden;
    }
    .device-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
    
    .status-available { background: linear-gradient(145deg, #ffffff, #f0fff4); border-color: #d1e7dd; color: #198754; }
    .status-inuse { background: linear-gradient(145deg, #ffffff, #fff5f5); border-color: #f8d7da; color: #dc3545; }
    .status-other { background: #f8f9fa; border-color: #e9ecef; color: #6c757d; }
    
    .selected { 
      border-color: #0d6efd !important; background: #e7f1ff !important;
      transform: translateY(-3px); box-shadow: 0 8px 20px rgba(13, 110, 253, 0.2); 
    }
    
    .device-id { font-size: 1.5rem; font-weight: 800; line-height: 1.2; }
    .device-info { font-size: 1rem; font-weight: 600; opacity: 0.9; margin-top: 4px; max-width: 90%; text-align: center; }

    /* --- éª¨æ¶å± Skeleton Loader (Bootstrap Placeholder) --- */
    .skeleton-card {
      height: 120px; border-radius: 16px; background: #fff; border: 1px solid #eee;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 15px; box-shadow: none; cursor: wait;
    }
    .skeleton-text { border-radius: 4px; }

    /* --- åº•éƒ¨èˆ‡å½ˆçª— --- */
    .role-switch { background: #f1f3f5; border-radius: 12px; padding: 4px; display: flex; margin-bottom: 20px; }
    .role-btn { flex: 1; border: none; padding: 8px; border-radius: 10px; font-weight: bold; color: #666; background: transparent; transition: 0.3s; }
    .role-btn.active { background: #fff; color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    
    #signature-pad-container { border: 2px dashed #ced4da; background: #fdfdfe; height: 180px; border-radius: 12px; overflow: hidden; }
    canvas { width: 100%; height: 100%; touch-action: none; }
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px; border-top: 1px solid #e9ecef; display: none; z-index: 1050; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
  </style>
</head>
<body>

<div class="container">
  <div class="header-section">
    <h2>è·¯ç«¹é«˜ä¸­å±…å®¶è¼‰å…·å€Ÿç”¨</h2>
    <p class="sub-title">è«‹é»é¸è¼‰å…·é€²è¡Œæ‰¹é‡å€Ÿç”¨æˆ–æ­¸é‚„</p>
    
    <button id="refresh-btn" class="btn-refresh" onclick="handleRefreshClick()">
      <span id="btn-icon">ğŸ”„</span>
      <span id="btn-text">é‡æ–°æ•´ç†åˆ—è¡¨</span>
    </button>
  </div>
  
  <div id="grid-container" class="row g-3">
    </div>
</div>

<div class="bottom-bar" id="bottomBar">
  <div class="d-flex justify-content-between align-items-center container">
    <span class="fs-5 fw-bold text-dark">å·²é¸ <span id="selectedCount" class="text-primary">0</span> å°</span>
    <button class="btn btn-primary btn-lg px-4 rounded-pill fw-bold shadow-sm" onclick="openBatchModal()">ä¸‹ä¸€æ­¥ï¼šå¡«å¯«è³‡æ–™</button>
  </div>
</div>

<div class="modal fade" id="actionModal" data-bs-backdrop="static" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold fs-4"><span id="modalActionTitle">æ‰¹é‡è™•ç†</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-4">
        
        <div class="role-switch" id="roleToggleArea">
          <button class="role-btn active" id="btnFaculty" onclick="setRole('Faculty')">ğŸ‘¨â€ğŸ« æ•™è·å“¡</button>
          <button class="role-btn" id="btnStudent" onclick="setRole('Student')">ğŸ‘¨â€ğŸ“ å­¸ç”Ÿ</button>
        </div>
        
        <div id="facultyInputArea" class="mb-3">
          <label class="form-label fw-bold text-secondary small" id="nameLabel">æ•™è·å“¡å§“å</label>
          <input type="text" id="facultyName" class="form-control form-control-lg bg-light" placeholder="è«‹è¼¸å…¥å§“å">
        </div>

        <div id="studentInputArea" class="mb-3" style="display:none;">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label fw-bold text-secondary small">å­¸åˆ¶</label>
              <select id="selSystem" class="form-select form-select-lg bg-light" onchange="updateClassList()">
                <option value="é«˜ä¸­éƒ¨">é«˜ä¸­éƒ¨</option>
                <option value="åœ‹ä¸­éƒ¨">åœ‹ä¸­éƒ¨</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label fw-bold text-secondary small">ç­ç´š</label>
              <select id="selClass" class="form-select form-select-lg bg-light"></select>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-bold text-secondary small">åº§è™Ÿ</label>
            <select id="selSeat" class="form-select form-select-lg bg-light"></select>
          </div>
        </div>
        
        <div class="mb-3" id="reasonArea">
          <label class="form-label fw-bold text-secondary small">å€Ÿç”¨åŸå› </label>
          <select id="borrowReason" class="form-select form-select-lg bg-light">
            <option value="æ•™å­¸ç”¨">æ•™å­¸ç”¨</option>
            <option value="å ±è®€ç”¨">å ±è®€ç”¨</option>
            <option value="åŒå­¸è«‹å‡(æ··æˆæ•™å­¸)">åŒå­¸è«‹å‡(æ··æˆæ•™å­¸)</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        
        <div class="p-3 bg-light rounded-3 mb-3">
           <div class="d-flex justify-content-between align-items-center mb-2">
             <label class="form-check-label fw-bold" for="powerCable">ğŸ”Œ é›»æºç·š</label>
             <div class="form-check form-switch">
               <input class="form-check-input" type="checkbox" id="powerCable" checked>
             </div>
           </div>
           <input type="text" id="note" class="form-control border-0 bg-white" placeholder="å‚™è¨» (ä¾‹å¦‚ï¼šå«å»¶é•·ç·š)">
        </div>
        
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label fw-bold text-secondary small">é›»å­ç°½å</label>
            <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="signaturePad.clear()">é‡ç°½</button>
          </div>
          <div id="signature-pad-container"><canvas id="signature-canvas"></canvas></div>
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-primary w-100 fw-bold py-3 rounded-3" id="submitBtn" onclick="submitBatch()">ç¢ºèªæäº¤</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS Web App ç¶²å€ â˜…â˜…â˜…
  // ==========================================
  const API_URL = "https://script.google.com/macros/s/AKfycbxAWulpRiVMiwYUSj5IFpc-9jctUAqoaylK6p7B9JZU7CgubeZiIugjIAfttoAAn7yq/exec";
  // ==========================================

  let signaturePad;
  let actionModal;
  let selectedDevices = [];
  let currentRole = 'Faculty';

  // å®šç¾©ç­ç´šçµæ§‹ (Hardcoded)
  const SCHOOL_DATA = {
    "é«˜ä¸­éƒ¨": [
      { start: 401, end: 407 },
      { start: 501, end: 507 },
      { start: 601, end: 607 }
    ],
    "åœ‹ä¸­éƒ¨": [
      { start: 101, end: 111 },
      { start: 201, end: 212 },
      { start: 301, end: 311 }
    ]
  };

  window.onload = () => {
    actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
    signaturePad = new SignaturePad(document.getElementById('signature-canvas'), {
        minWidth: 1, maxWidth: 2.5, penColor: "rgb(0, 0, 0)"
    });
    document.getElementById('actionModal').addEventListener('shown.bs.modal', resizeCanvas);
    
    initStudentData(); // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    loadDevices();     // è¼‰å…¥è¨­å‚™
  };

  async function callApi(action, data = {}) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, ...data })
      });
      return await response.json();
    } catch (e) {
      console.error("API Error:", e);
      Swal.fire('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨', 'error');
      throw e;
    }
  }

  // --- éª¨æ¶å±æ¸²æŸ“ (Skeleton) ---
  function renderSkeleton() {
    const container = document.getElementById('grid-container');
    let html = '';
    // ç”¢ç”Ÿ 12 å€‹éª¨æ¶å¡ç‰‡
    for(let i=0; i<12; i++) {
        html += `
        <div class="col-6 col-md-3">
          <div class="skeleton-card" aria-hidden="true">
             <div class="placeholder-glow w-100 text-center">
                <span class="placeholder col-6 mb-3 bg-secondary skeleton-text" style="height:24px;"></span>
                <span class="placeholder col-8 bg-light skeleton-text" style="height:16px;"></span>
             </div>
          </div>
        </div>`;
    }
    container.innerHTML = html;
  }

  function handleRefreshClick() {
    const btn = document.getElementById('refresh-btn');
    const btnIcon = document.getElementById('btn-icon');
    btn.disabled = true;
    btnIcon.classList.add('spin');
    loadDevices();
  }

  function loadDevices() {
    selectedDevices = [];
    document.getElementById('bottomBar').style.display = 'none';
    
    // 1. å…ˆé¡¯ç¤ºéª¨æ¶å±
    renderSkeleton();

    // 2. å‘¼å« API
    callApi('getDeviceStatus').then(devices => {
        // 3. æ¸²æŸ“çœŸå¯¦æ•¸æ“š
        renderGrid(devices);
        
        // 4. é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        const btn = document.getElementById('refresh-btn');
        const btnIcon = document.getElementById('btn-icon');
        btn.disabled = false;
        btnIcon.classList.remove('spin');
    });
  }

  function renderGrid(devices) {
    const container = document.getElementById('grid-container');
    container.innerHTML = ''; // æ¸…ç©ºéª¨æ¶

    if (devices.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-5">ç›®å‰æ²’æœ‰è¼‰å…·è³‡æ–™</div>';
        return;
    }

    devices.forEach(d => {
      let statusClass = (d.status === 'å¯å€Ÿç”¨') ? 'status-available' : (d.status === 'å…¶ä»–' ? 'status-other' : 'status-inuse');
      let displayInfo = (d.status === 'å¯å€Ÿç”¨') ? 'å¯å€Ÿç”¨' : (d.status === 'å…¶ä»–' ? (d.user || 'ç¶­ä¿®/å…¶ä»–') : d.user);
      
      container.innerHTML += `
        <div class="col-6 col-md-3">
          <div class="device-card ${statusClass}" id="card-${d.id}" onclick="toggleSelect('${d.id}', '${d.status}', '${d.user}')">
            <div class="device-id">${d.id}</div>
            <div class="device-info text-truncate">${displayInfo}</div>
          </div>
        </div>`;
    });
  }

  // --- åˆå§‹åŒ–å­¸ç”Ÿè³‡æ–™ (å–ä»£èˆŠçš„ loadUserData) ---
  function initStudentData() {
    const selSeat = document.getElementById('selSeat');
    // ç”¢ç”Ÿåº§è™Ÿ 01-40 + å…¶ä»–
    selSeat.innerHTML = '';
    for (let i = 1; i <= 45; i++) {
      let val = i.toString().padStart(2, '0');
      selSeat.innerHTML += `<option value="${val}è™Ÿ">${val}è™Ÿ</option>`;
    }
    selSeat.innerHTML += `<option value="å…¶ä»–">å…¶ä»–</option>`;
    
    // è§¸ç™¼ä¸€æ¬¡ç­ç´šæ›´æ–°
    updateClassList();
  }

  function updateClassList() {
    const sys = document.getElementById('selSystem').value;
    const selClass = document.getElementById('selClass');
    selClass.innerHTML = '';

    const rules = SCHOOL_DATA[sys];
    if (rules) {
        rules.forEach(range => {
            for(let c = range.start; c <= range.end; c++) {
                selClass.innerHTML += `<option value="${c}">${c}</option>`;
            }
        });
    }
  }

  function setRole(role) {
    currentRole = role;
    document.getElementById('btnFaculty').classList.toggle('active', role === 'Faculty');
    document.getElementById('btnStudent').classList.toggle('active', role === 'Student');
    document.getElementById('facultyInputArea').style.display = (role === 'Faculty') ? 'block' : 'none';
    document.getElementById('studentInputArea').style.display = (role === 'Student') ? 'block' : 'none';
  }

  function toggleSelect(id, status, user) {
    if (status === 'å…¶ä»–') {
      Swal.fire({ icon: 'error', title: 'ç„¡æ³•é¸å–', text: 'æ­¤è¼‰å…·ç›®å‰ç‹€æ…‹ç‚ºã€Œå…¶ä»–ã€ï¼Œä¸å¯é€²è¡Œå€Ÿé‚„', timer: 1500, showConfirmButton: false });
      return;
    }
    const card = document.getElementById('card-' + id);
    const index = selectedDevices.findIndex(d => d.id === id);
    if (index > -1) {
      selectedDevices.splice(index, 1);
      card.classList.remove('selected');
    } else {
      if (selectedDevices.length > 0 && selectedDevices[0].status !== status) {
        Swal.fire('é¸å–é™åˆ¶', 'ä¸å¯åŒæ™‚é¸å–å€Ÿå‡ºèˆ‡æ­¸é‚„è¼‰å…·', 'warning');
        return;
      }
      selectedDevices.push({id, status, user});
      card.classList.add('selected');
    }
    document.getElementById('bottomBar').style.display = selectedDevices.length > 0 ? 'block' : 'none';
    document.getElementById('selectedCount').innerText = selectedDevices.length;
  }

  function resizeCanvas() {
    const canvas = document.getElementById('signature-canvas');
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }

  function openBatchModal() {
    const type = (selectedDevices[0].status === 'å¯å€Ÿç”¨') ? 'å€Ÿå‡º' : 'æ­¸é‚„';
    document.getElementById('modalActionTitle').innerText = `${type}ç¢ºèª (${selectedDevices.length}å°)`;
    
    const reasonArea = document.getElementById('reasonArea');
    const nameLabel = document.getElementById('nameLabel');

    if (type === 'æ­¸é‚„') {
      nameLabel.innerText = "æ­¸é‚„è€…å§“å";
      document.getElementById('roleToggleArea').style.display = 'none';
      document.getElementById('facultyInputArea').style.display = 'block';
      document.getElementById('studentInputArea').style.display = 'none';
      
      // å¦‚æœæ˜¯æ­¸é‚„ï¼Œé å¡«ç¬¬ä¸€å°çš„ä½¿ç”¨è€…åç¨±
      document.getElementById('facultyName').value = selectedDevices[0].user;
      
      reasonArea.style.display = 'none'; 
      document.getElementById('borrowReason').value = 'å…¶ä»–'; 
    } else {
      nameLabel.innerText = "æ•™è·å“¡å§“å";
      document.getElementById('roleToggleArea').style.display = 'flex';
      setRole('Faculty');
      document.getElementById('facultyName').value = '';
      reasonArea.style.display = 'block';
      document.getElementById('borrowReason').value = 'æ•™å­¸ç”¨'; 
    }
    actionModal.show();
  }

  function submitBatch() {
    let finalName = "";
    if (currentRole === 'Faculty' || selectedDevices[0].status === 'å¤–å€Ÿä¸­') {
      finalName = document.getElementById('facultyName').value;
    } else {
      finalName = `${document.getElementById('selSystem').value}${document.getElementById('selClass').value} (${document.getElementById('selSeat').value})`;
    }

    if (!finalName || signaturePad.isEmpty()) {
      Swal.fire('å¡«å¯«æœªå®Œæˆ', 'è«‹æä¾›å§“åèˆ‡ç°½å', 'info');
      return;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

    const payload = {
      deviceIds: selectedDevices.map(d => d.id),
      userName: finalName,
      type: (selectedDevices[0].status === 'å¯å€Ÿç”¨') ? 'å€Ÿå‡º' : 'æ­¸é‚„',
      reason: document.getElementById('borrowReason').value,
      powerCable: document.getElementById('powerCable').checked,
      note: document.getElementById('note').value,
      signature: signaturePad.toDataURL()
    };

    callApi('processTransaction', payload).then(res => {
        if(res.status === 'success'){
            Swal.fire({
              icon: 'success', 
              title: 'å®Œæˆ', 
              text: res.message, 
              confirmButtonColor: '#0d6efd'
            });
            actionModal.hide();
            loadDevices();
        } else {
            Swal.fire('å¤±æ•—', res.message, 'error');
        }
        btn.disabled = false; btn.innerText = "ç¢ºèªæäº¤";
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
